<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Example</title>
</head>
<body>
    <h1>WebSocket Test</h1>
    <canvas id="gomokuCanvas" width="600" height="600"></canvas>

    <script>
        GAME_ID = 0
        PLAYER_ID = 0
        function init() {
            websocket = new WebSocket("ws://127.0.0.1:8000/ws");
            websocket.binaryType = 'arraybuffer';
            websocket.onopen = function(e) { onOpen(e) };
            websocket.onclose = function(e) { onClose(e) };
            websocket.onmessage = function(e) { onMessage(e) };
            websocket.onerror = function(e) { onError(e) };
        }

        function send_msg(data) {
            const buffer = new ArrayBuffer(3);
            const view = new DataView(buffer);

            view.setUint8(0, GAME_ID);  
            view.setUint8(1, PLAYER_ID);  
            view.setUint8(2, data); 
            console.log("send", GAME_ID, PLAYER_ID, data)
            websocket.send(buffer); 
        }

        function recv(message) {
            if (!(message instanceof ArrayBuffer)) {
                console.error("Expected ArrayBuffer but received:", message);
                return;
            }
            const view = new DataView(message);

            const game_id = view.getUint8(0);
            const player_id = view.getUint8(1);
            const state = view.getUint8(2);
            const turn = view.getUint8(3);

            // Reading the 225-byte string
            let str = '';
            for (let i = 0; i < 225; i++) {
                const charCode = view.getUint8(4 + i);
                if (charCode === 0) break; // Stop at the null terminator
                str += String.fromCharCode(charCode);
            }
            console.log(game_id, player_id, state, turn, str)
            return [game_id, player_id, state, turn, str]
        }

        function onOpen(e) {
            console.log(e.type, e);
            /*
            IF nie ma id user w pamieci to send 0
            Else send id usera 0<id>
            */

            send_msg(255)
            // websocket.send("0<id>");
        }

        function onMessage(e) {
            let [game_id, sign, state, turn, board] = recv(e.data)
            GAME_ID = game_id
            PLAYER_ID = sign
            drawBoard(board, turn)
            /*
                If 11xxx
                    zaoisanie do storage if gracza
                Else:
                    zaprezentowanie stanu gry
            */
            console.log(e.type + ': '  + e.data);
            // websocket.close();
        }

        function onClose(e) {
            console.log(e.type);
        }

        function onError(e) {
            console.error(e.type);
        }
        function f(i) {
            send_msg(i)
        }

        window.addEventListener("load", init, false);

        const canvas = document.getElementById('gomokuCanvas');
        const context = canvas.getContext('2d');
        const boardSize = 15;
        const cellSize = canvas.width / boardSize;

        // Rysowanie linii siatki
        function drawBoard(data, turn) {
            context.beginPath();
            for (let i = 0; i <= boardSize; i++) {
                // Rysowanie pionowych linii
                context.moveTo(i * cellSize, 0);
                context.lineTo(i * cellSize, canvas.height);
                // Rysowanie poziomych linii
                context.moveTo(0, i * cellSize);
                context.lineTo(canvas.width, i * cellSize);
            }
            context.strokeStyle = "#000";
            context.stroke();
            if(data == "") return;

            for (let x = 0; x < boardSize*boardSize; x++) {
                if(data[x] == "1") {
                    drawGreen(parseInt(x/15), x%15);
                }
                if(data[x] == "2" || (data[x] == "1" && turn == 0)) {
                    drawO(parseInt(x/15), x%15);
                }
                if(data[x] == "3" || (data[x] == "1" && turn == 1)) {
                    drawX(parseInt(x/15), x%15);
                }
                
                // for (let col = 0; col < boardSize; col++) {
                //     if (board[row][col] === 1) {
                //         drawX(row, col);
                //     } else if (board[row][col] === 2) {
                //     } else if (board[row][col] === 3) {
                //         drawGreen(row, col);
                //     }
                // }
            }
        }

        function drawX(row, col) {
            const x = col * cellSize;
            const y = row * cellSize;
            context.beginPath();
            context.moveTo(x + 10, y + 10);
            context.lineTo(x + cellSize - 10, y + cellSize - 10);
            context.moveTo(x + cellSize - 10, y + 10);
            context.lineTo(x + 10, y + cellSize - 10);
            context.strokeStyle = "#f00";
            context.stroke();
        }

        // Funkcja rysująca kółko
        function drawO(row, col) {
            const x = col * cellSize + cellSize / 2;
            const y = row * cellSize + cellSize / 2;
            context.beginPath();
            context.arc(x, y, cellSize / 2 - 10, 0, 2 * Math.PI);
            context.strokeStyle = "#00f";
            context.stroke();
        }

        // Funkcja rysująca zielony prostokąt
        function drawGreen(row, col) {
            const x = col * cellSize;
            const y = row * cellSize;
            context.fillStyle = "#0f0";
            context.fillRect(x + 1, y + 1, cellSize - 2, cellSize - 2);
        }

        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const row = Math.floor(y / cellSize);
            const col = Math.floor(x / cellSize);
            f(row*15 + col);
        });

        drawBoard("", 0);
    </script>
    <table>
        <tr>
            <td>
                <button type="button" onclick="f(1)">1</button>
                <button type="button" onclick="f(2)">2</button>
                <button type="button" onclick="f(3)">3</button>
            </td>
        </tr>
        <tr>
            <td>
                <button type="button" onclick="f(4)">4</button>
                <button type="button" onclick="f(5)">5</button>
                <button type="button" onclick="f(6)">6</button>
            </td>
        </tr>
        <tr>
            <td>
                <button type="button" onclick="f(7)">7</button>
                <button type="button" onclick="f(8)">8</button>
                <button type="button" onclick="f(9)">9</button>
            </td>
        </tr>
    </table>
</body>
</html>
